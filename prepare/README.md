# подготовка данных

подготавливаем данные, полученные из UCD, для использования в декомпозиции.

в таблице Unicode 15.0.0 для кодирования символа используется 21 бит, но есть нюансы:

- все определенные в таблице символы используют максимум 20 бит. все символы, которые начинаются от `U+F0000` - Private Use.
- последний кодпоинт, задействованный в декомпозиции - `U+2FA1D`, его значение кодируется 18-ю битами.
- большая часть символов кодируется 16 битами.

## в каком виде храним данные

наша задача - хранить CCC и декомпозицию (кодпоинты декомпозиции с их CCC).

### таблица данных

- разбиваем таблицу на блоки по 128 кодпоинтов (наиболее удобный размер, в результате получаем файлы с данными наименьшего размера).
- блок может быть пустым (содержать символы, не имеющие декомпозиции). так как нам незачем хранить такой блок, создаём несколько таблиц:
  - таблица индексов блоков
  - блоки данных
  - кодпоинты, декомпозиция которых не помещается в предыдущую таблицу

### запись кодпоинта

как можно увидеть из проведённых ранее тестов:

в NFD:

- в декомпозиции присутствует от 1 до 4 символов.
- основная часть - синглтоны, пары и тройки.

в NFKD:

- в декомпозиции присутствует от 1 до 18 элементов.
- основная часть - синглтоны, пары и тройки.
- по одному кодпоинту на 6, 7, 8, 18 символов в декомпозиции

возможны следующие варианты для кодпоинта:

1. стартер без декомпозиции
2. нестартер без декомпозиции
3. синглтон (16 и 18 бит)
4. пара (16 и 18 бит)

   - стартер + стартер
   - стартер + нестартер

5. тройка (16 и 18 бит)

   - стартер + стартер + стартер
   - стартер + стартер + нестартер
   - стартер + нестартер + стартер
   - стартер + нестартер + нестартер

6. стартер с декомпозицией в нестартер
7. нестартер с декомпозицией
8. декомпозиция на несколько нестартеров
9. декомпозиция начинается со стартера, и содержит:

   - только стартеры, или нестартер присутствует в середине декомпозиции
   - что угодно, заканчивается нестартером (только одним)

если в декомпозиции подряд идут несколько нестартеров, они упорядочены по CCC.

#### битовые представления символов

все битовые представения u64 представлены как big endian

`ccсccccc` , `cycycycy`, `czczczcz` - (8 бит) - ССС нестартера в записи

`iiii....` - (16 бит) - индекс последовательности кодпоинтов в таблице expansions

`nnnnnnnn` - (8 бит) - количество кодпоинтов в последовательности в таблице expansions


```
____ ____  ____ ____    ____ ____  ____ ____    ____ ____  ____ ____    ____ ____  0000 0000 - стартер без декомпозиции
____ ____  ____ ____    ____ ____  ____ ____    ____ ____  ____ ____    cccc cccc  0000 0001 - не стартер, только CCC
____ ____  ____ ____    yyyy yyyy  yyyy yyyy    xxxx xxxx  xxxx xxxx    cycy cycy  0000 0010 - 16-битная пара с CCC 2го символа
xxxx xxxx  xxxx xxxx    xxxx xxxx  xxxx xxxx    ____ ____  ____ ____    ____ ____  0000 0011 - синглтон (16/18 бит)
____ ____  ____ ____    ____ ____  ____ ____    iiii iiii  iiii iiii    nnnn nnnn  0000 0100 - декомпозиция, вынесенная во внешний блок
czcz czcz  cycy cycy    zzzz zzzz  zzzz zzzz    yyyy yyyy  yyyy yyyy    xxxx xxxx  xxxx xxxx - 16-битная тройка, храним 2 ссс кода
```

тройки не пересекаются с маркерами потому, что минимально возможное значение первого байта первого кодпоинта декомпозиции тройки - `0x20`.
